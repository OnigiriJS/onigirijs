/*!
 * ===============================================================
 *      ____        _       _      _      _  _____ 
 *     / __ \      (_)     (_)    (_)    | |/ ____|
 *    | |  | |_ __  _  __ _ _ _ __ _     | | (___  
 *    | |  | | '_ \| |/ _` | | '__| |_   | |\___ \ 
 *    | |__| | | | | | (_| | | |  | | |__| |____) |
 *     \____/|_| |_|_|\__, |_|_|  |_|\____/|_____/ 
 *                     __/ |                       
 *                    |___/                        
 * ===============================================================
 *
 *   Lightweight, deliciously simple, modular JavaScript framework for building reactive HumHub modules with enterprise-grade security
 *
 *   Website:   https://onigirijs.greenmeteor.net/
 *   License:   BSD-3-Clause
 *
 *   Copyright (c) 2025 Green Meteor
 *
 *   Redistribution and use in source and binary forms, with or
 *   without modification, are permitted provided that the
 *   conditions of the BSD 3-Clause License are met.
 *
 *   SPDX-License-Identifier: BSD-3-Clause
 * ===============================================================
 */
window.formatPrice=function(usdPrice){if(typeof Onigiri!=='undefined'&&typeof Onigiri.i18n!=='undefined'&&typeof Onigiri.i18n.formatPrice==='function'){return Onigiri.i18n.formatPrice(usdPrice);}
return'$'+usdPrice.toFixed(2);};function injectAnimateModule(){const Easing={linear:t=>t,easeOutQuad:t=>t*(2-t),easeInOutQuad:t=>t<0.5?2*t*t:-1+(4-2*t)*t};function animate(element,options){const{duration=300,easing='easeOutQuad',onProgress,onComplete}=options;const easingFunc=Easing[easing]||Easing.linear;let start=null;const step=(timestamp)=>{if(!start)start=timestamp;const elapsed=timestamp-start;const progress=Math.min(elapsed / duration,1);const easedProgress=easingFunc(progress);if(onProgress){onProgress(easedProgress,progress);}
if(progress<1){requestAnimationFrame(step);}else if(onComplete){onComplete();}};requestAnimationFrame(step);}
Onigiri.prototype.fadeIn=function(duration,callback){duration=duration||300;this.each(el=>{const originalDisplay=el.style.display;const computedDisplay=window.getComputedStyle(el).display;el.style.opacity='0';el.style.display=originalDisplay==='none'||!originalDisplay?(computedDisplay==='none'?'block':computedDisplay):originalDisplay;animate(el,{duration,easing:'easeOutQuad',onProgress:(easedProgress)=>{el.style.opacity=easedProgress;},onComplete:()=>{el.style.opacity='';if(callback)callback.call(el);}});});return this;};Onigiri.prototype.fadeOut=function(duration,callback){duration=duration||300;this.each(el=>{const initialOpacity=parseFloat(window.getComputedStyle(el).opacity)||1;animate(el,{duration,easing:'easeOutQuad',onProgress:(easedProgress)=>{el.style.opacity=initialOpacity*(1-easedProgress);},onComplete:()=>{el.style.display='none';el.style.opacity='';if(callback)callback.call(el);}});});return this;};Onigiri.prototype.slideDown=function(duration,callback){duration=duration||300;this.each(el=>{el.style.display='block';el.style.overflow='hidden';const height=el.scrollHeight;el.style.height='0';el.offsetHeight;animate(el,{duration,easing:'easeOutQuad',onProgress:(easedProgress)=>{el.style.height=(height*easedProgress)+'px';},onComplete:()=>{el.style.height='';el.style.overflow='';if(callback)callback.call(el);}});});return this;};Onigiri.prototype.slideUp=function(duration,callback){duration=duration||300;this.each(el=>{const height=el.scrollHeight;el.style.height=height+'px';el.style.overflow='hidden';el.offsetHeight;animate(el,{duration,easing:'easeOutQuad',onProgress:(easedProgress)=>{el.style.height=(height*(1-easedProgress))+'px';},onComplete:()=>{el.style.display='none';el.style.height='';el.style.overflow='';if(callback)callback.call(el);}});});return this;};Onigiri.modules.animate=true;}
document.addEventListener('DOMContentLoaded',function(){if(!Onigiri.modules.animate){injectAnimateModule();}
Onigiri.security.init({autoInjectCSRF:true});const FALLBACK_MENU_DATA=[{id:1,nameKey:'menu.salmon.name',descKey:'menu.salmon.desc',price:3.50,emoji:'ðŸŸ'},{id:2,nameKey:'menu.tuna.name',descKey:'menu.tuna.desc',price:3.50,emoji:'ðŸ '},{id:3,nameKey:'menu.umeboshi.name',descKey:'menu.umeboshi.desc',price:3.00,emoji:'ðŸŒ¸'},{id:4,nameKey:'menu.chicken.name',descKey:'menu.chicken.desc',price:4.00,emoji:'ðŸ—'},{id:5,nameKey:'menu.vegetable.name',descKey:'menu.vegetable.desc',price:3.25,emoji:'ðŸ¥¬'},{id:6,nameKey:'menu.shrimp.name',descKey:'menu.shrimp.desc',price:4.50,emoji:'ðŸ¤'}];if(typeof Onigiri!=='undefined'&&typeof Onigiri.i18n!=='undefined'&&typeof Onigiri.i18n.translatePage==='function'){Onigiri.i18n.translatePage();}
const shop=new Onigiri.prototype.Component({data:{menu:[],cart:[],loading:false},computed:{cartTotal(){return this.cart.reduce((sum,item)=>sum+(item.price*item.quantity),0);},cartCount(){return this.cart.reduce((sum,item)=>sum+item.quantity,0);}},methods:{loadMenu(){this.loading=true;setTimeout(()=>{this.menu=FALLBACK_MENU_DATA.map(item=>{const translatedName=Onigiri.t(item.nameKey);const translatedDesc=Onigiri.t(item.descKey);return{id:item.id,name:translatedName||'Unknown Item',description:translatedDesc||'',price:item.price,emoji:item.emoji,nameKey:item.nameKey,descKey:item.descKey};});this.loading=false;this.renderMenu();},300);},renderMenu(){const container=O('#menu-container');container.empty();const addToCartText=Onigiri.t('shop.addToCart')||'Add to Cart';this.menu.forEach(item=>{const formattedPrice=window.formatPrice(item.price);container.append(`<div class="menu-item"><h3>${item.emoji}${item.name}</h3><p class="description">${item.description}</p><div class="price">${formattedPrice}</div><button class="btn add-to-cart"data-id="${item.id}">${addToCartText}</button></div>`);});O('.add-to-cart').on('click',(e)=>{const id=parseInt(O(e.target).data('id'),10);const item=this.menu.find(i=>i.id===id);this.addToCart(item);});},addToCart(item){const existingItem=this.cart.find(i=>i.id===item.id);if(existingItem){existingItem.quantity++;}else{this.cart.push({...item,quantity:1});}
this.updateCart();const message=Onigiri.t('cart.itemAdded',{name:item.name})||'Added '+item.name+' to cart!';showNotification(message);},removeFromCart(id){this.cart=this.cart.filter(item=>item.id!==id);this.updateCart();},updateQuantity(id,delta){const item=this.cart.find(i=>i.id===id);if(item){item.quantity+=delta;if(item.quantity<=0){this.removeFromCart(id);}else{this.updateCart();}}},updateCart(){const cartItems=O('#cart-items');cartItems.empty();if(this.cart.length){this.cart.forEach(item=>{const formattedPrice=window.formatPrice(item.price);cartItems.append(`<div class="cart-item"><div><div class="cart-item-name">${item.emoji}${item.name}</div><div style="color:#666;font-size:.875rem;">${formattedPrice}Ã—${item.quantity}</div></div><div class="cart-item-controls"><button onclick="shop.updateQuantity(${item.id}, -1)">âˆ’</button><span>${item.quantity}</span><button onclick="shop.updateQuantity(${item.id}, 1)">+</button></div></div>`);});O('#checkout-btn').removeAttr('disabled');}else{const emptyText=Onigiri.t('cart.empty')||'Cart is empty';cartItems.html('<p style="text-align:center;color:#999;">'+emptyText+'</p>');O('#checkout-btn').attr('disabled',true);}
const formattedTotal=window.formatPrice(this.cartTotal);O('#cart-total').text(formattedTotal);this.saveCart();},saveCart(){Onigiri.storage.set('cart',this.cart);},loadCart(){this.cart=Onigiri.storage.get('cart',[]);this.updateCart();},checkout(){const formattedTotal=window.formatPrice(this.cartTotal);const message=Onigiri.t('cart.orderPlaced',{total:formattedTotal})||'Order placed! Total: '+formattedTotal;showNotification(message,3000);this.cart=[];this.updateCart();}},created(){this.loadCart();},mounted(){this.loadMenu();}});shop.mount('body');window.shop=shop;const counter=new Onigiri.prototype.Component({data:{count:0,eventsCount:0},methods:{increment(){this.count++;this.eventsCount++;this.updateStats();},updateStats(){O('#counter-value').text(this.count);O('#storage-items').text(Onigiri.storage.keys().length);O('#events-fired').text(this.eventsCount);}},created(){this.count=Onigiri.storage.get('counter',0);this.updateStats();}});counter.mount('body');window.showNotification=function(message,duration){duration=duration||2000;const notification=O('#notification');notification.html(message);notification.fadeIn(200);setTimeout(()=>notification.fadeOut(200),duration);};O('#checkout-btn').on('click',()=>shop.checkout());O('#increment-btn').on('click',()=>counter.increment());O('.tab-btn').on('click',function(){const tab=O(this).data('tab');O('.tab-btn').removeClass('active');O(this).addClass('active');O('.demo-section').removeClass('active');O('#'+tab+'-section').addClass('active');});O('.accordion-header').on('click',function(){const header=this;const content=header.nextElementSibling;const isOpen=header.classList.contains('open');const allHeaders=document.querySelectorAll('.accordion-header');const allContents=document.querySelectorAll('.accordion-content');allHeaders.forEach(h=>h.classList.remove('open'));allContents.forEach(c=>{if(c!==content&&window.getComputedStyle(c).display!=='none'){O(c).slideUp(300);}});if(!isOpen&&content){O(header).addClass('open');O(content).slideDown(300);}});O('#language-select').on('change',function(){const newLocale=this.value;Onigiri.i18n.setLocale(newLocale);document.title=Onigiri.t('page.title')||'Onigiri Shop - OnigiriJS Demo';shop.loadMenu();shop.updateCart();if(typeof Onigiri.security!=='undefined'&&Onigiri.security.getToken){fetch('set_locale.php',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded',},body:'locale='+newLocale+'&_csrf='+Onigiri.security.getToken()}).catch(err=>console.log('Could not save locale to server:',err.message));}});window.demoAnimations=function(){const box=O('#animation-box');box.fadeOut(300,()=>{box.css('background','linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)');box.fadeIn(300,()=>{box.pulse(600,()=>{box.shake(500,()=>{box.bounce(600,()=>{box.rotate(360,600,'easeOutBack',()=>{box.scale(1.1,300,'easeOutElastic',()=>{box.scale(1,300,'easeOutQuad');});});});});});});});showNotification('ðŸŽ¨ Running animation sequence!',2000);};window.demoStorage=function(){const testKey='demo_test_'+Date.now();Onigiri.storage.set(testKey,{test:true,timestamp:Date.now()});O('#storage-count').text(Onigiri.storage.keys().length);let prefix='onigiri_';try{if(Onigiri.storage._config&&Onigiri.storage._config.prefix){prefix=Onigiri.storage._config.prefix;}else if(Onigiri.storage.config&&Onigiri.storage.config.prefix){prefix=Onigiri.storage.config.prefix;}else if(typeof Onigiri.storage.getPrefix==='function'){prefix=Onigiri.storage.getPrefix();}}catch(e){console.warn('Could not access storage prefix:',e);}
O('#storage-prefix').text(prefix);showNotification('Storage test completed!');};window.demoSecurity=function(){const token=Onigiri.security.getToken();O('#csrf-token').text(token.substring(0,20)+'...');O('#security-status').text('Yes');showNotification('Security features active!');};let eventCounter=0;window.demoEvents=function(){eventCounter++;O('#event-count').text(eventCounter);O('body').trigger('onigiri:demo',{count:eventCounter});showNotification('ðŸŽ¯ Custom event triggered! Count: '+eventCounter,2000);};let demoComponentValue=0;window.demoComponent=function(action){if(action==='increment'){demoComponentValue++;}else if(action==='decrement'){demoComponentValue--;}else if(action==='reset'){demoComponentValue=0;}
O('#demo-component-value').text(demoComponentValue);O('#demo-component-value').pulse(400);showNotification('Component value: '+demoComponentValue);};const demoLocales=['en','es','fr','ja'];let currentDemoLocaleIndex=0;window.demoI18n=function(){currentDemoLocaleIndex=(currentDemoLocaleIndex+1)%demoLocales.length;const newLocale=demoLocales[currentDemoLocaleIndex];Onigiri.i18n.setLocale(newLocale);O('#current-locale').text(newLocale.toUpperCase());O('#available-locales').text(demoLocales.length);const demoText=Onigiri.t('header.subtitle')||'A complete demonstration of OnigiriJS features';O('#translation-demo').text(demoText);O('#translation-demo').fadeOut(200,()=>{O('#translation-demo').fadeIn(200);});showNotification('ðŸŒ Locale changed to: '+newLocale.toUpperCase(),2000);};window.demoAjax=function(){O('#ajax-status').text('Loading...');setTimeout(()=>{O('#ajax-status').text('Success! âœ“');O('#ajax-status').pulse(400);showNotification('ðŸ“¡ AJAX request completed successfully!',2000);setTimeout(()=>{O('#ajax-status').text('Ready');},2000);},1000);};let debounceCount=0;const debouncedIncrement=Onigiri.debounce(()=>{debounceCount++;O('#debounce-count').text(debounceCount);O('#debounce-count').pulse(300);},1000);window.demoDebounce=function(){debouncedIncrement();showNotification('â±ï¸ Click rapidly! Only last call in 1s executes',1500);};let throttleCount=0;const throttledIncrement=Onigiri.throttle(()=>{throttleCount++;O('#throttle-count').text(throttleCount);O('#throttle-count').pulse(300);},1000);window.demoThrottle=function(){throttledIncrement();showNotification('âš¡ Click rapidly! Max 1 call per second',1500);};O('#current-locale').text(Onigiri.i18n.getLocale().toUpperCase());O('#available-locales').text(demoLocales.length);O('#translation-demo').text(Onigiri.t('header.subtitle')||'A complete demonstration of OnigiriJS features');if(!Onigiri.modules.animate){injectAnimateModule();}});
